<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script>

    function hexToUint8Array(hexString) {
      const length = hexString.length / 2;
      const uint8Array = new Uint8Array(length);
      for (let i = 0; i < length; i++) {
        const byte = parseInt(hexString.substr(i * 2, 2), 16);
        uint8Array[i] = byte;
      }
      return uint8Array;
    }

    function fetchAB(url, cb) {
      console.log(url);
      var xhr = new XMLHttpRequest;
      xhr.open('get', url);
      xhr.responseType = 'arraybuffer';
      xhr.onload = function () {
        cb(xhr.response);
      };
      xhr.send();
    };

    // fragmented mp4 を MSE で読み込む。
    function setMediaSource(video, assetURL, mimeCodec) {
      if (!MediaSource.isTypeSupported(mimeCodec)) {
        console.error('Unsupported MIME type or codec: ', mimeCodec);
        return;
      }
      const mediaSource = new MediaSource();
      video.src = URL.createObjectURL(mediaSource);
      mediaSource.addEventListener('sourceopen', () => {
        const sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
        fetchAB(assetURL, (buf) => {
          sourceBuffer.addEventListener('updateend', () => {
            // mediaSource.endOfStream();
            video.play();
            console.log(mediaSource.readyState); // ended
          });
          sourceBuffer.appendBuffer(buf);
        });
      });
    }

    function start() {
      const video = document.querySelector('video');

      const assetURL = 'output_frag_encrypted.mp4';
      const videoCodec = 'avc1.42C01E';
      const audioCodec = 'mp4a.40.2';
      const mime = `video/mp4; codecs="${videoCodec}, ${audioCodec}"`;
      const encryption_key = hexToUint8Array('9c61173d2db8939009be4bd689533ade');
      const encryption_kid = hexToUint8Array('a53fcebc83532682766c7d0e012fe92f');

      // 暗号化されたメディアを検知したら呼び出される
      video.addEventListener('encrypted', setupMediaKeySession);

      (async () => {
        // MediaKey を作成して video にセットする
        const config = [{
          initDataTypes: ['cenc'],
          videoCapabilities: [{
            contentType: `video/mp4; codecs="${videoCodec}"`
          }],
          audioCapabilities: [{
            contentType: `audio/mp4; codecs="${audioCodec}"`
          }]
        }];

        const keySystemAccess = await navigator.requestMediaKeySystemAccess('org.w3.clearkey', config);
        const mediaKeys = await keySystemAccess.createMediaKeys();
        await video.setMediaKeys(mediaKeys);
      })();

      setMediaSource(video, assetURL, mime);

      // 暗号化されたメディアを検知したら呼び出される
      async function setupMediaKeySession(event) {
        try {
          const {initDataType, initData} = event;
          console.log('onencrypted:', 'initDataType=', initDataType, 'initData=', initData)
          const mediaKeys = video.mediaKeys;

          // セッションを作成する。
          const session = mediaKeys.createSession();
          session.addEventListener('message', onMessage);
          await session.generateRequest(initDataType, initData);
        } catch (error) {
          console.error('EME setup failed:', error);
        }
      }

      function onMessage(event) {
        const session = event.target;
        const message = event.message;
        console.log('onmessage');
        // ライセンスサーバとやり取りをするが、ClearKey なので、
        // ライセンスを作って返す。
        const license = createLicense(message);
        session.update(license).catch((e) => console.error(e));
      }

      function toBase64Url(u8arr) {
        // btoa を使うと Base64 になってしまい、Base64URL でない
        // 適切に置換する
        return btoa(String.fromCharCode.apply(null, u8arr))
          .replace(/\+/g, '-')
          .replace(/\//g, '_')
          .replace(/=*$/, '');
      }

      function createLicense(message) {
        const request = JSON.parse(new TextDecoder().decode(message));
        console.log('request:', request);
        const response = {
          keys: [
            {
              kty: "oct",
              alg: "A128KW",
              use: "enc",
              kid: request.kids[0],  // same as encryption_kid
              k: toBase64Url(encryption_key)
            }]
        };
        console.log('response', response);
        return new TextEncoder().encode(JSON.stringify(response));
      }
    }

  </script>
</head>

<body>

  <div>
    <video controls></video>
    <button onclick="start()">START</button>
  </div>

  <p>(CC) Blender Foundation | mango.blender.org</p>
</body>

</html>